<!doctype html>
<html>

	<head>
		<meta charset="utf-8"/>
		<title>Backbone Weather</title>
		<link rel="stylesheet" media="all" href=""/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script type="text/javascript" src="http://ajax.cdnjs.com/ajax/libs/underscore.js/1.1.4/underscore-min.js"></script>
		<script type="text/javascript" src="http://ajax.cdnjs.com/ajax/libs/backbone.js/0.3.3/backbone-min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.js"></script>
	</head>
	
	<body lang="en">
	    <div id="appview">
	        <input id="searchbox" type="text" />
	        <div id="weatherList">
	        </div>
	    </div>
	    
	    <script type="text/template" id="weatherPerDay">

            <% _.each( weathers, function( day_item ){ %>

	            <h1><%= day_item.get("date") %></h1>
	            
	            <div>Min t: <%= day_item.get("day").mintemp_c %> </div>
	            <div>Max t: <%= day_item.get("day").maxtemp_c %> </div>

            <% }); %>

        </script>
    
	    <script type="text/javascript">
	        $(document).ready( function(){
	            WeathersEntry = Backbone.Model.extend({
	                // A collection doesn't neccesarily have to set
	                // a model but it makes the code more clear and
	                // later on you can add extra functionality with ease
	            });
	            WeathersCollection = Backbone.Collection.extend({
	                model: WeathersEntry, 
	                initialize: function(){
	                    // When initialized we want to associate a view with this collection
	                    this.weatherList = new WeathersList;
	                    // Backbone lets us "listen" for certain events
	                    // In this case when the collection receives an array
	                    // of models we want to re-render the list view
	                    this.bind("refresh", this.weatherList.renderList);
	                },
	            });
	            
	            WeathersList = Backbone.View.extend({
	                el: $("#weatherList"), // Every view has a element associated with it
	                initialize: function(){
	                    // Set the initial content of the view
	                    this.el.html("Type to search for city weather");
	                },
	                renderList: function( collection ){
	                    // This function is called when the collection "listens"
	                    // for the "refresh" event which is called in our loadResults()
	                    // Now we want to compile our underscore template
	                    // The underscore template just takes a string of text/html 
	                    var compiled_template = _.template( $("#weatherPerDay").html() );
	                    // Once compiled we can call our template and pass it any 
	                    // matching data we have and append it to our view.el
	                    collection.weatherList.el.html( compiled_template( { weathers: collection.models } ) );
	                }
	            });
	            AppView = Backbone.View.extend({
	                el: $("#appview"),
	                initialize: function(){
	                    // Lets create an empty collection to store the weathers
	                    this.weathers_collection = new WeathersCollection;
	                },
	                events: {
	                    // Events are attached when Backbone starts and 
	                    // there are many types. We are simply listening for
	                    // "keypress" on the input field #searchbox
	                    "keypress #searchbox": "loadResults"
	                },
	                loadResults: function(event){
	                    // results is passed an event object which we 
	                    // can use to get the input text, also note "this"
	                    // refers to the current view
	                    query = $(event.currentTarget).val();
	                    
	                    // Now we will use jquery deferred objects to get 
	                    // data from the API
	                    $.when( this.ajaxGetWeathers( query ) )
	                    .then( $.proxy( function( response ){
	                        // Below is accessing all the weathers from google api
	                        // It puts it in a big json string and I am 
	                        // simply selecting it
							entries = response.forecast.forecastday;
	                        // Now we pass the array of json objects to add to the collection
	                        this.weathers_collection.refresh( entries );

	                    }, this ) ); // $.proxy is a useful way of passing the parent object to the anonymous function
	                },
	                ajaxGetWeathers: function( query ){
	                    // Google is damn fast, return the ajax function to pass the promise() test in the $.when statement
	                    var ajaxQuery =  $.ajax("http://api.apixu.com/v1/forecast.json?key=c1f93b42acf84432a1482548172310&q=" + query + "&days=3");
	                    return ajaxQuery; 
	                }
	            
	            });
	            // Create an app view once the document has loaded
	            var appview = new AppView;
	        })

	    </script>
	</body>
</html>